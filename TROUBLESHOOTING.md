# æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ” Stream è¿æ¥æˆåŠŸä½†æ”¶ä¸åˆ°æ¶ˆæ¯

### ç—‡çŠ¶
```
âœ… Gateway å¯åŠ¨æˆåŠŸ
âœ… Stream è¿æ¥å·²å»ºç«‹
âœ… HA WebSocket å·²è¿æ¥
âŒ åœ¨é’‰é’‰å‘æ¶ˆæ¯ï¼ŒGateway æ²¡æœ‰æ—¥å¿—ï¼ŒHA æ²¡æœ‰æ”¶åˆ°
```

### ğŸ“‹ æ£€æŸ¥æ¸…å•

#### 1. é’‰é’‰å¼€æ”¾å¹³å°é…ç½®ï¼ˆæœ€å¸¸è§é—®é¢˜ï¼‰

##### 1.1 æ£€æŸ¥äº‹ä»¶è®¢é˜…

**æ­¥éª¤**ï¼š
1. ç™»å½•é’‰é’‰å¼€æ”¾å¹³å°ï¼šhttps://open-dev.dingtalk.com/
2. è¿›å…¥ä½ çš„åº”ç”¨
3. æ‰¾åˆ° **"å¼€å‘é…ç½®"** â†’ **"äº‹ä»¶ä¸å›è°ƒ"**
4. æ£€æŸ¥æ˜¯å¦è®¢é˜…äº†ä»¥ä¸‹äº‹ä»¶ï¼š

**å¿…é¡»è®¢é˜…çš„äº‹ä»¶**ï¼š
- âœ… **æœºå™¨äººæ¥æ”¶æ¶ˆæ¯** (`ChatbotMessage`)
- âœ… **ç¾¤èŠæœºå™¨äººæ¶ˆæ¯** (å¦‚æœè¦æ”¯æŒç¾¤èŠ)

**å¦‚ä½•è®¢é˜…**ï¼š
```
1. ç‚¹å‡» "è®¢é˜…äº‹ä»¶"
2. æ‰¾åˆ° "æœºå™¨äººæ¶ˆæ¯"
3. å‹¾é€‰ï¼š
   - âœ“ å•èŠæœºå™¨äººæ¶ˆæ¯
   - âœ“ ç¾¤èŠæœºå™¨äººæ¶ˆæ¯
4. ç‚¹å‡» "ä¿å­˜"
5. ç‚¹å‡» "å‘å¸ƒé…ç½®"ï¼ˆé‡è¦ï¼ï¼‰
```

âš ï¸ **æ³¨æ„**ï¼šé…ç½®ä¿®æ”¹åå¿…é¡»ç‚¹å‡»"å‘å¸ƒé…ç½®"æ‰ä¼šç”Ÿæ•ˆï¼

##### 1.2 æ£€æŸ¥ Stream æ¨é€é…ç½®

**æ­¥éª¤**ï¼š
1. åœ¨å¼€æ”¾å¹³å°ï¼Œè¿›å…¥åº”ç”¨
2. **"å¼€å‘é…ç½®"** â†’ **"Stream æ¨é€é…ç½®"**
3. ç¡®è®¤çŠ¶æ€ä¸ºï¼š**å·²å¼€å¯**

å¦‚æœæœªå¼€å¯ï¼š
```
1. ç‚¹å‡» "å¼€å¯ Stream æ¨é€"
2. é€‰æ‹©è®¢é˜…äº‹ä»¶
3. ä¿å­˜å¹¶å‘å¸ƒ
```

##### 1.3 æ£€æŸ¥åº”ç”¨æƒé™

**æ­¥éª¤**ï¼š
1. **"æƒé™ç®¡ç†"** â†’ **"æ¥å£æƒé™"**
2. ç¡®è®¤æœ‰ä»¥ä¸‹æƒé™ï¼š

**å¿…éœ€æƒé™**ï¼š
- âœ… ä¼ä¸šå†…æœºå™¨äººå‘é€æ¶ˆæ¯ï¼ˆqyapi_robot.sendmessageï¼‰
- âœ… æ¥æ”¶æ¶ˆæ¯ï¼ˆqyapi_chat.messageï¼‰
- âœ… è¯»å–é€šè®¯å½•ï¼ˆcontactsï¼‰

**ç”³è¯·æƒé™**ï¼š
```
1. æ‰¾åˆ°ç¼ºå¤±çš„æƒé™
2. ç‚¹å‡» "ç”³è¯·æƒé™"
3. å¡«å†™ç”³è¯·ç†ç”±
4. ç­‰å¾…å®¡æ‰¹ï¼ˆé€šå¸¸è‡ªåŠ¨é€šè¿‡ï¼‰
```

---

#### 2. ç¡®è®¤å‘é€æ¶ˆæ¯çš„æ–¹å¼

##### 2.1 å•èŠæœºå™¨äºº

**æ­£ç¡®æ–¹å¼**ï¼š
1. åœ¨é’‰é’‰ä¸­ï¼Œæ‰¾åˆ°ä½ çš„æœºå™¨äººåº”ç”¨
2. ç‚¹å‡»è¿›å…¥ä¸æœºå™¨äººçš„**å•èŠå¯¹è¯**
3. ç›´æ¥å‘é€æ¶ˆæ¯

**é”™è¯¯æ–¹å¼**ï¼š
- âŒ åœ¨ç¾¤é‡Œå‘æ¶ˆæ¯ä½†æ²¡æœ‰@æœºå™¨äºº
- âŒ ç»™å…¶ä»–äººå‘æ¶ˆæ¯

##### 2.2 ç¾¤èŠæœºå™¨äºº

**æ­£ç¡®æ–¹å¼**ï¼š
1. å°†æœºå™¨äººæ·»åŠ åˆ°ç¾¤èŠ
2. åœ¨ç¾¤é‡Œ **@æœºå™¨äºº** å¹¶å‘é€æ¶ˆæ¯
   - ä¾‹å¦‚ï¼š`@æˆ‘çš„æœºå™¨äºº ä½ å¥½`

**é”™è¯¯æ–¹å¼**ï¼š
- âŒ ä¸@æœºå™¨äººç›´æ¥å‘æ¶ˆæ¯
- âŒ æœºå™¨äººæœªåŠ å…¥ç¾¤èŠ

---

#### 3. æ£€æŸ¥ Gateway æ—¥å¿—

##### 3.1 æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u dingtalk-gateway -f

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
sudo journalctl -u dingtalk-gateway -n 100 --no-pager

# æœç´¢é”™è¯¯
sudo journalctl -u dingtalk-gateway | grep -i error
```

##### 3.2 é¢„æœŸçœ‹åˆ°çš„æ—¥å¿—

**æ”¶åˆ°æ¶ˆæ¯æ—¶**ï¼š
```
[DingTalk] Received message from ç”¨æˆ·å: æ¶ˆæ¯å†…å®¹
[DingTalk] Message processing time: 5.23ms
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ°**ï¼šè¯´æ˜ Gateway æ²¡æœ‰æ”¶åˆ°é’‰é’‰æ¨é€

---

#### 4. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

##### 4.1 éªŒè¯ .env é…ç½®
```bash
cd ~/dingtalk-ha-gateway
cat .env
```

**å¿…éœ€é…ç½®**ï¼š
```bash
DINGTALK_CLIENT_ID=ding3guton...  # æ­£ç¡®å¡«å†™
DINGTALK_CLIENT_SECRET=hXtOnx__re...  # æ­£ç¡®å¡«å†™
DINGTALK_AGENT_ID=2934819482  # æ­£ç¡®å¡«å†™ï¼ˆçº¯æ•°å­—ï¼‰
DINGTALK_USE_STREAM=true  # å¿…é¡»ä¸º true
```

##### 4.2 éªŒè¯å‡­è¯æ˜¯å¦æ­£ç¡®

**è·å–å‡­è¯çš„ä½ç½®**ï¼š
1. é’‰é’‰å¼€æ”¾å¹³å°ï¼šhttps://open-dev.dingtalk.com/
2. è¿›å…¥ä½ çš„åº”ç”¨
3. **"åº”ç”¨ä¿¡æ¯"** â†’ **"åŸºæœ¬ä¿¡æ¯"**
   - ClientIdï¼ˆAppKeyï¼‰
   - ClientSecretï¼ˆAppSecretï¼‰
4. **"åº”ç”¨ä¿¡æ¯"** â†’ **"åŸºç¡€ä¿¡æ¯"**
   - AgentIdï¼ˆåº”ç”¨IDï¼Œçº¯æ•°å­—ï¼‰

---

#### 5. æµ‹è¯• Stream è¿æ¥

##### 5.1 æ£€æŸ¥ Stream è¿æ¥çŠ¶æ€

åœ¨æ—¥å¿—ä¸­æŸ¥æ‰¾ï¼š
```bash
sudo journalctl -u dingtalk-gateway | grep -i stream
```

**æ­£å¸¸æ—¥å¿—**ï¼š
```
[DingTalk] Starting Stream connection...
endpoint is {'endpoint': 'wss://wss-open-connection.dingtalk.com:443/connect', ...}
```

##### 5.2 æ‰‹åŠ¨æµ‹è¯• Stream

åˆ›å»ºæµ‹è¯•è„šæœ¬ï¼š
```bash
cd ~/dingtalk-ha-gateway
nano test_dingtalk.py
```

ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼š
```python
import os
from dotenv import load_dotenv
from dingtalk_stream import AckMessage
import dingtalk_stream

load_dotenv()

CLIENT_ID = os.getenv("DINGTALK_CLIENT_ID")
CLIENT_SECRET = os.getenv("DINGTALK_CLIENT_SECRET")

print(f"ClientId: {CLIENT_ID}")
print(f"ClientSecret: {CLIENT_SECRET[:10]}...")

class MyHandler(dingtalk_stream.ChatbotHandler):
    def __init__(self):
        super().__init__()
    
    async def process(self, callback: dingtalk_stream.CallbackMessage):
        print(f"âœ… æ”¶åˆ°æ¶ˆæ¯: {callback.data}")
        return AckMessage.STATUS_OK, 'OK'

def main():
    credential = dingtalk_stream.Credential(CLIENT_ID, CLIENT_SECRET)
    client = dingtalk_stream.DingTalkStreamClient(credential)
    client.register_callback_handler(dingtalk_stream.chatbot.ChatbotMessage.TOPIC, MyHandler())
    print("ğŸš€ Stream å®¢æˆ·ç«¯å¯åŠ¨ï¼Œç­‰å¾…æ¶ˆæ¯...")
    client.start_forever()

if __name__ == '__main__':
    main()
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
source venv/bin/activate
python test_dingtalk.py
```

ç„¶ååœ¨é’‰é’‰ç»™æœºå™¨äººå‘æ¶ˆæ¯ï¼Œçœ‹æ˜¯å¦æ‰“å° `âœ… æ”¶åˆ°æ¶ˆæ¯`

---

#### 6. å¸¸è§é”™è¯¯åŠè§£å†³

##### é”™è¯¯ 1ï¼šæƒé™ä¸è¶³
```
é”™è¯¯ä¿¡æ¯: Access denied
è§£å†³: åœ¨å¼€æ”¾å¹³å°ç”³è¯·æ‰€éœ€æƒé™
```

##### é”™è¯¯ 2ï¼šæœªè®¢é˜…äº‹ä»¶
```
ç—‡çŠ¶: Stream è¿æ¥æˆåŠŸä½†æ”¶ä¸åˆ°æ¶ˆæ¯
è§£å†³: è®¢é˜… "æœºå™¨äººæ¥æ”¶æ¶ˆæ¯" äº‹ä»¶å¹¶å‘å¸ƒé…ç½®
```

##### é”™è¯¯ 3ï¼šå‡­è¯é”™è¯¯
```
é”™è¯¯ä¿¡æ¯: Invalid credentials
è§£å†³: æ£€æŸ¥ ClientId, ClientSecret, AgentId æ˜¯å¦æ­£ç¡®
```

##### é”™è¯¯ 4ï¼šStream æœªå¼€å¯
```
ç—‡çŠ¶: æ— æ³•å»ºç«‹ Stream è¿æ¥
è§£å†³: åœ¨å¼€æ”¾å¹³å°å¼€å¯ Stream æ¨é€é…ç½®
```

---

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ®ä½ çš„æ—¥å¿—ï¼ˆStream å·²è¿æ¥ä½†æ”¶ä¸åˆ°æ¶ˆæ¯ï¼‰ï¼Œ**æœ€å¯èƒ½çš„åŸå› æ˜¯**ï¼š

### âŒ æœªè®¢é˜…äº‹ä»¶æˆ–æœªå‘å¸ƒé…ç½®

**ç«‹å³æ£€æŸ¥**ï¼š
1. ç™»å½• https://open-dev.dingtalk.com/
2. è¿›å…¥åº”ç”¨ â†’ å¼€å‘é…ç½® â†’ äº‹ä»¶ä¸å›è°ƒ
3. ç¡®è®¤å·²è®¢é˜… "æœºå™¨äººæ¥æ”¶æ¶ˆæ¯"
4. **ç‚¹å‡» "å‘å¸ƒé…ç½®"**ï¼ˆè¿™ä¸€æ­¥æœ€å®¹æ˜“å¿˜è®°ï¼ï¼‰

### âŒ å‘é€æ¶ˆæ¯æ–¹å¼ä¸å¯¹

**ç¡®è®¤**ï¼š
- å•èŠï¼šç›´æ¥åœ¨ä¸æœºå™¨äººçš„å¯¹è¯ä¸­å‘æ¶ˆæ¯
- ç¾¤èŠï¼šå¿…é¡» @æœºå™¨äºº

---

## ğŸ“ è¯¦ç»†æ’æŸ¥æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šéªŒè¯é’‰é’‰é…ç½®ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# 1. ç™»å½•é’‰é’‰å¼€æ”¾å¹³å°
https://open-dev.dingtalk.com/

# 2. è¿›å…¥ä½ çš„åº”ç”¨

# 3. æ£€æŸ¥äº‹ä»¶è®¢é˜…
å¼€å‘é…ç½® â†’ äº‹ä»¶ä¸å›è°ƒ â†’ ç¡®è®¤å·²è®¢é˜… "æœºå™¨äººæ¶ˆæ¯"

# 4. æ£€æŸ¥ Stream æ¨é€
å¼€å‘é…ç½® â†’ Stream æ¨é€é…ç½® â†’ ç¡®è®¤ "å·²å¼€å¯"

# 5. å‘å¸ƒé…ç½®ï¼ˆé‡è¦ï¼ï¼‰
ç‚¹å‡»é¡µé¢ä¸Šçš„ "å‘å¸ƒé…ç½®" æŒ‰é’®
```

### ç¬¬äºŒæ­¥ï¼šéªŒè¯ç¯å¢ƒå˜é‡ï¼ˆ2åˆ†é’Ÿï¼‰

```bash
cd ~/dingtalk-ha-gateway
cat .env | grep DINGTALK

# ç¡®è®¤ä¸‰ä¸ªå€¼éƒ½å·²æ­£ç¡®å¡«å†™
DINGTALK_CLIENT_ID=ding...
DINGTALK_CLIENT_SECRET=...
DINGTALK_AGENT_ID=...ï¼ˆçº¯æ•°å­—ï¼‰
```

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•å‘é€æ¶ˆæ¯ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# 1. åœ¨é’‰é’‰ä¸­æ‰¾åˆ°ä½ çš„æœºå™¨äºº
# 2. è¿›å…¥å•èŠå¯¹è¯
# 3. å‘é€ï¼šæµ‹è¯•
# 4. ç«‹å³æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u dingtalk-gateway -f
```

**é¢„æœŸæ—¥å¿—**ï¼š
```
[DingTalk] Received message from ä½ çš„åå­—: æµ‹è¯•
```

---

## ğŸ”§ å¿«é€Ÿä¿®å¤

### å¦‚æœç¡®è®¤æ˜¯äº‹ä»¶è®¢é˜…é—®é¢˜ï¼š

```bash
# 1. åœ¨å¼€æ”¾å¹³å°è®¢é˜…äº‹ä»¶å¹¶å‘å¸ƒ
# 2. é‡å¯ Gatewayï¼ˆè®©é…ç½®ç”Ÿæ•ˆï¼‰
sudo systemctl restart dingtalk-gateway

# 3. æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u dingtalk-gateway -f

# 4. é‡æ–°æµ‹è¯•å‘é€æ¶ˆæ¯
```

### å¦‚æœæ˜¯å‡­è¯é—®é¢˜ï¼š

```bash
# 1. ä¿®æ”¹ .env
cd ~/dingtalk-ha-gateway
nano .env

# 2. å¡«å†™æ­£ç¡®çš„å‡­è¯
# 3. é‡å¯æœåŠ¡
sudo systemctl restart dingtalk-gateway
```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. **é’‰é’‰å¼€æ”¾å¹³å°æˆªå›¾**ï¼š
   - äº‹ä»¶è®¢é˜…é¡µé¢
   - Stream æ¨é€é…ç½®é¡µé¢
   - æƒé™ç®¡ç†é¡µé¢

2. **å®Œæ•´æ—¥å¿—**ï¼š
```bash
sudo journalctl -u dingtalk-gateway -n 200 --no-pager
```

3. **ç¯å¢ƒå˜é‡**ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰ï¼š
```bash
cat .env | sed 's/CLIENT_SECRET=.*/CLIENT_SECRET=***HIDDEN***/'
```

4. **æµ‹è¯•ç»“æœ**ï¼š
   - å¦‚ä½•å‘é€çš„æ¶ˆæ¯ï¼ˆå•èŠ/ç¾¤èŠï¼‰
   - æ˜¯å¦@äº†æœºå™¨äººï¼ˆç¾¤èŠæƒ…å†µä¸‹ï¼‰
   - æ˜¯å¦çœ‹åˆ°æ¶ˆæ¯å·²é€è¾¾ï¼ˆé’‰é’‰æ˜¾ç¤ºå·²è¯»ï¼‰

---

## âœ… è§£å†³åçš„éªŒè¯

æˆåŠŸåä½ åº”è¯¥çœ‹åˆ°ï¼š

### Gateway æ—¥å¿—
```
[DingTalk] Received message from å²©é£: ä½ å¥½
[DingTalk] Message processing time: 5.23ms
```

### Home Assistant
- Sensor `sensor.dingtalk_gateway_last_message` æ›´æ–°
- äº‹ä»¶ `dingtalk_message` è§¦å‘
- è‡ªåŠ¨åŒ–è¢«è§¦å‘ï¼ˆå¦‚æœé…ç½®äº†ï¼‰

---

**æœ€åæ›´æ–°**: 2025-11-10  
**é€‚ç”¨ç‰ˆæœ¬**: v0.1.1+
